Title: Установка
Date: 2023-01-07 12:23
Category: docs
Slug: installation
Lang: ru

Сначала крепко подумайте -- нужно ли Вам тратить время на эту программу ?

В сети сейчас так мало информации об Umbrella Linux, что скорее всего Вы
ничего об этой системе не знаете. Если так, то может быть она Вам и
не нужна ? Найдите кого-нибудь (в Интернете или реале), кто может
рассказать Вам о ней. Или просто подождите, когда здесь появится больше
информации.

Лучший способ попробовать Umbrella Linux -- установить его в
виртуальную машину под управлением VirtualBox.

1. Скачайте 
[установочный образ сервера Ubuntu 22.04 "Jammy" ](https://releases.ubuntu.com/releases/22.04/ubuntu-22.04.1-live-server-amd64.iso) .

2. Создайте виртуальную машину для Umbrella Server. Примерно (с
минимальным запасом места для домашних папок пользователей или их почты)
понадобится виртуальная машина с 15Гб диском, 4Gb оперативной памяти и
парочкой виртуальных процессоров. Подключите к её виртуальному CD приводу
скачанный Вами ранее установочный образ.

    При установке в VirtualBox с сетевым адаптером в режиме сетевого моста, 
убедитесь, что для него разрешён неразборчивый режим (promiscous mode).

    *Необязательно:* на физическом или виртуальном компьютере с
Umbrella Server желательно иметь хотя бы две сетевых карточки -- одну для
внешней сети, а вторую для внутренней. Подключая к внутренней сети другие
компьютеры (виртуалки), можно будет разворачивать на них рабочие станции
и/или использовать их как терминалы. Если нет второй сетевой карточки
(или другой возможности подключиться к сетевому мосту "pub" внутри
виртуалки), то системой можно будет пользоваться только так, как будто Вы
находитесь вне её.

3. Загрузите виртуальную машину и установите на ней Ubuntu Server со всеми
настройками по умолчанию. Не устанавливайти никакого дополнительного ПО.
Создайте временного пользователя с простым паролем.

4. После окончания установки Ubuntu, войдите в него под временным
пользователем и, при помощи команды `sudo -i`, станьте root-ом. Потом скачайте
(командой `wget`) все файлы из [этого каталога](../../installer/) 
(например, при помощи `wget -e robots=off -R 'index.html*' -r -np -nd -nc -l 1 https://metlov.github.io/umbrella-linux/installer/` ).
Эти файлы -- простой текст. В том числе и bash скрипт `./umbrella-install`,
которому после скачивания нужно дать права для исполнения командой
`chmod +x ./umbrella-install`. Если хотите сгенерировать
уникальные пароли и сертификаты для своей системы 
(это необходимо, в частности, если Вы изменили имя или местоположение системы в
файле umbrella.xml) -- удалите файл
 `umbrella_keys.xml` (он будет перегенерирован программой установки).
Не устанавливайте дополнительных пакетов (кроме разве что `mc` и `aptitude`).

5. Просмотрите `*.xml` файлы и поменяйте настройки в них. Поскольку
документации сейчас нет -- желательно проконсультироваться при этом с
кем-нибудь, кто их уже видел. Как минимум, в umbrella.xml нужно проверить
имя сервера виртуальных машин vmhost (должно совпадать с именем
компьютера, указанным при установки Ubuntu) и параметры (MAC, IP и
gateway) внешнего интерфейса (extif) в сервере router. Важно, чтобы
последние (включая MAC) точно соответствовали реальным действующим
параметрам внешнего интерфейса на только что развёрнутом Ubuntu server
(выдаваемым командами `ip addr` и `ip route`). В то время как для
интерфейса extif можно выбрать любой свободный MAC и IP.

6. Запустите скрипт `./umbrella-install`. Он должен провести установку в
автоматическом режиме.
Установка может занять часа полтора, в зависимости от скорости
жесткого диска.

Что делать дальше ?

Средствами VirtualBox можно пробросить через NAT какой-нибудь порт (скажем
10022) на порт 22 первого (внешнего) сетевого интерфейса Вашей виртуальной машины. Это
позволит соединиться с ней по протоколу ssh. Чтобы войти, используйте имя
первого административного пользователя, указанного в umbrella.xml и пароль,
который сообщила Вам программа установки. Вы так же можете войти в свою
новую систему в графическом режиме используя клиент X2Go. При создании сессии,
там нужно будет выбрать "Другой тип сессии" и набрать `umbrella-session` в 
текстовом поле, в качестве адреса укажите localhost порт 10022. Внутри
графической оболочки Вы можете запустить браузер и зайти на
`https://config.<ваш домен из umbrella.xml>/` в интерфейс Fusion
Directory, который позволяет регистрировать пользователей, группы и рабочие
станции. Подключив компьютеры/виртуалки ко второму физическому
интерфейсу Umbrella Server и зарегистрировав их MAC адреса в Fusion Directory,
можно будет загрузить их по PXE в терминальном режиме, либо развернуть на них
по сети рабочие станции.

Более детальный вариант этих инструкций можно найти в файле
`Documentation/installer/README` репозитория Umbrella Linux или
внутри действующей конфигурации Вашего кластера Umbrella Linux
на его сервере конфигурации (по умлочанию `config`) в 
каталоге `/var/lib/bcfg2`.
